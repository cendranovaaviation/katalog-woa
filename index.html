<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WOA Fleet Hub - Katalog Armada & Koneksi</title>
    <!-- Chosen Palette: Aviation Aero - Background: Slate-50, Primary: Sky-600, Accents: Indigo-600, Success: Emerald-500 -->
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc, updateDoc, query, where } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";

        // Global expose for Babel
        window.FirebaseBridge = { initializeApp, getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc, updateDoc, query, where, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .chart-container { position: relative; width: 100%; max-width: 500px; margin: auto; height: 300px; }
        .animate-fade-up { animation: fadeUp 0.5s ease-out forwards; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // Initialize Firebase services outside component (Pola Wajib)
        const firebaseConfig = JSON.parse(window.__firebase_config || '{"apiKey": "AIzaSyAwzTQJpzU3qPXaYnbHBG-JmZtAjMERKJs", "authDomain": "woa-fleet-hub.firebaseapp.com", "projectId": "woa-fleet-hub", "storageBucket": "woa-fleet-hub.firebasestorage.app", "messagingSenderId": "174974455884", "appId": "1:174974455884:web:155bd58e8cde28c22b64e9"}');
        const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'woa-fleet-hub-v1';
        
        const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc } = window.FirebaseBridge;
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Icons placeholder (Lucide)
        const Icon = ({ name, size = 20, className = "" }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        function App() {
            const [user, setUser] = useState(null);
            const [fleet, setFleet] = useState([]);
            const [requests, setRequests] = useState([]);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [loading, setLoading] = useState(true);

            // Form State
            const [formData, setFormData] = useState({
                reg: '', type: '', manufacturer: 'Boeing', cat: 'M',
                status: 'Parkir', range: 5000, seats: 150, livery: 'Standard'
            });

            // 1. Authentication (RULE 3 - FIRST and AWAIT)
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof window.__initial_auth_token !== 'undefined' && window.__initial_auth_token) {
                            await signInWithCustomToken(auth, window.__initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Authentication error:", error);
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                });
                return () => unsubscribe();
            }, []);

            // 2. Data Fetching (Separate useEffect with [user] dependency)
            useEffect(() => {
                if (!user) return;

                // Sync Fleet (RULE 1 - Strict Path)
                const fleetCol = collection(db, 'artifacts', appId, 'public', 'data', 'fleet');
                const unsubFleet = onSnapshot(fleetCol, 
                    (snap) => {
                        setFleet(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                        setLoading(false);
                    },
                    (error) => console.error("Fleet fetch error:", error)
                );

                // Sync Requests (RULE 1 - Strict Path)
                const reqCol = collection(db, 'artifacts', appId, 'public', 'data', 'requests');
                const unsubReq = onSnapshot(reqCol, 
                    (snap) => {
                        setRequests(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                    },
                    (error) => console.error("Requests fetch error:", error)
                );

                return () => {
                    unsubFleet();
                    unsubReq();
                };
            }, [user]);

            // Dashboard Chart
            const chartRef = useRef(null);
            useEffect(() => {
                if (activeTab === 'dashboard' && fleet.length > 0) {
                    const ctx = document.getElementById('fleetChart')?.getContext('2d');
                    if (ctx) {
                        if (chartRef.current) chartRef.current.destroy();
                        const manuMap = {};
                        fleet.forEach(p => manuMap[p.manufacturer] = (manuMap[p.manufacturer] || 0) + 1);
                        
                        chartRef.current = new Chart(ctx, {
                            type: 'doughnut',
                            data: {
                                labels: Object.keys(manuMap),
                                datasets: [{
                                    data: Object.values(manuMap),
                                    backgroundColor: ['#0284c7', '#4f46e5', '#10b981', '#f59e0b', '#ef4444'],
                                    borderWidth: 0
                                }]
                            },
                            options: { responsive: true, maintainAspectRatio: false, cutout: '70%' }
                        });
                    }
                }
            }, [activeTab, fleet]);

            // Database Handlers
            const addPlane = async (e) => {
                e.preventDefault();
                if (!user) return;
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'fleet'), {
                        ...formData,
                        ownerId: user.uid,
                        range: Number(formData.range),
                        seats: Number(formData.seats),
                        createdAt: new Date().toISOString()
                    });
                    setIsModalOpen(false);
                    setFormData({ reg: '', type: '', manufacturer: 'Boeing', cat: 'M', status: 'Parkir', range: 5000, seats: 150, livery: 'Standard' });
                } catch (err) { alert("Gagal menambah data."); }
            };

            const sendConnectionRequest = async (plane) => {
                if (!user) return;
                const reqName = prompt("Masukkan Username WOA Anda untuk request koneksi:");
                if (!reqName) return;

                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'requests'), {
                        planeId: plane.id,
                        planeReg: plane.reg,
                        ownerId: plane.ownerId,
                        requesterName: reqName,
                        requesterUid: user.uid,
                        status: 'pending',
                        timestamp: new Date().toISOString()
                    });
                    alert("Request koneksi berhasil dikirim!");
                } catch (err) { console.error(err); }
            };

            const handleUpdateStatus = async (id, status) => {
                if (!user) return;
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'requests', id), { status });
                } catch (err) { console.error(err); }
            };

            const handleDeletePlane = async (id) => {
                if (!user) return;
                if (!confirm("Hapus pesawat ini?")) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'fleet', id));
                } catch (err) { console.error(err); }
            };

            const myPlanes = fleet.filter(p => p.ownerId === user?.uid);
            const incomingReqs = requests.filter(r => r.ownerId === user?.uid && r.status === 'pending');

            if (loading) return (
                <div className="h-screen flex flex-col items-center justify-center bg-slate-50">
                    <div className="w-12 h-12 border-4 border-sky-600 border-t-transparent rounded-full animate-spin mb-4"></div>
                    <p className="font-bold text-sky-600">Menghubungkan ke Radar...</p>
                </div>
            );

            return (
                <div className="min-h-screen">
                    {/* Navigation */}
                    <nav className="bg-white border-b border-slate-200 sticky top-0 z-50">
                        <div className="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <div className="bg-sky-600 p-2 rounded-xl text-white shadow-lg"><Icon name="plane" /></div>
                                <span className="font-black text-xl tracking-tight hidden sm:block uppercase text-slate-800">Fleet Hub</span>
                            </div>
                            <div className="flex gap-1">
                                <NavTab active={activeTab === 'dashboard'} onClick={() => setActiveTab('dashboard')} icon="layout-dashboard" label="Beranda" />
                                <NavTab active={activeTab === 'fleet'} onClick={() => setActiveTab('fleet')} icon="list" label="Katalog" />
                                <NavTab active={activeTab === 'inbox'} onClick={() => setActiveTab('inbox')} icon="bell" label="Inbox" badge={incomingReqs.length} />
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-6xl mx-auto px-4 py-8">
                        {/* VIEW: DASHBOARD */}
                        {activeTab === 'dashboard' && (
                            <div className="space-y-8 animate-fade-up">
                                <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                    <div>
                                        <h1 className="text-3xl font-black text-slate-900">Pusat Kendali</h1>
                                        <p className="text-slate-500 text-sm">Monitor armada pribadi dan permintaan koneksi global.</p>
                                    </div>
                                    <button onClick={() => setIsModalOpen(true)} className="bg-sky-600 hover:bg-sky-700 text-white font-bold px-6 py-3 rounded-2xl shadow-xl shadow-sky-100 flex items-center gap-2 transition-all active:scale-95">
                                        <Icon name="plus-circle" /> Tambah Pesawat
                                    </button>
                                </div>

                                <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                                    <StatCard label="Pesawat Saya" value={myPlanes.length} icon="plane" color="text-sky-600" bg="bg-sky-50" />
                                    <StatCard label="Request Masuk" value={incomingReqs.length} icon="mail" color="text-amber-600" bg="bg-amber-50" />
                                    <StatCard label="Kapasitas Pax" value={myPlanes.reduce((s, p) => s + p.seats, 0).toLocaleString()} icon="users" color="text-indigo-600" bg="bg-indigo-50" />
                                    <StatCard label="Total Global" value={fleet.length} icon="globe" color="text-slate-500" bg="bg-slate-50" />
                                </div>

                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                    <div className="bg-white p-6 rounded-3xl border border-slate-200 shadow-sm">
                                        <h3 className="font-bold text-slate-800 mb-6 flex items-center gap-2">
                                            <span className="w-1.5 h-5 bg-sky-500 rounded-full"></span>
                                            Distribusi Pabrikan
                                        </h3>
                                        <div className="chart-container">
                                            {fleet.length > 0 ? <canvas id="fleetChart"></canvas> : <div className="flex h-full items-center justify-center text-slate-300">Belum ada data</div>}
                                        </div>
                                    </div>
                                    <div className="bg-indigo-600 rounded-3xl p-8 text-white shadow-xl flex flex-col justify-between">
                                        <div>
                                            <h3 className="text-2xl font-black mb-2">Bagikan Katalog</h3>
                                            <p className="text-indigo-100 text-sm opacity-90 mb-6 leading-relaxed">
                                                Gunakan link website ini untuk memamerkan armada Anda ke komunitas World of Airports agar pemain lain dapat mengajukan permintaan koneksi.
                                            </p>
                                            <div className="bg-white/10 p-3 rounded-xl border border-white/20 flex items-center justify-between">
                                                <code className="text-xs truncate mr-2">{window.location.href}</code>
                                                <button onClick={() => { navigator.clipboard.writeText(window.location.href); alert("Link disalin!"); }} className="bg-white text-indigo-600 text-[10px] font-black px-3 py-1.5 rounded-lg">COPY</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* VIEW: FLEET CATALOG */}
                        {activeTab === 'fleet' && (
                            <div className="space-y-6 animate-fade-up">
                                <div>
                                    <h2 className="text-2xl font-black text-slate-900">Katalog Armada</h2>
                                    <p className="text-slate-500 text-sm">Daftar pesawat yang tersedia di jaringan global.</p>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {fleet.map(p => (
                                        <div key={p.id} className="bg-white rounded-[2rem] border border-slate-200 shadow-sm hover:shadow-xl transition-all overflow-hidden flex flex-col">
                                            <div className="p-6 flex-grow">
                                                <div className="flex justify-between items-start mb-4">
                                                    <div>
                                                        <span className="font-mono font-black text-xl text-slate-900 block">{p.reg}</span>
                                                        <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest">{p.manufacturer}</span>
                                                    </div>
                                                    <span className={`text-[10px] font-black px-2 py-1 rounded-lg uppercase ${
                                                        p.cat === 'XL' ? 'bg-purple-100 text-purple-600' :
                                                        p.cat === 'L' ? 'bg-indigo-100 text-indigo-600' :
                                                        p.cat === 'M' ? 'bg-blue-100 text-blue-600' : 'bg-slate-100 text-slate-600'
                                                    }`}>
                                                        Class {p.cat}
                                                    </span>
                                                </div>
                                                <h4 className="font-bold text-slate-800 mb-1">{p.type}</h4>
                                                <div className="flex gap-4 mb-4 text-[11px] font-bold text-slate-500">
                                                    <span>âœˆ {p.range.toLocaleString()} NM</span>
                                                    <span>ðŸ‘¥ {p.seats} Pax</span>
                                                </div>
                                                <p className="text-xs text-slate-400 italic">Livery: {p.livery}</p>
                                            </div>
                                            <div className="p-4 bg-slate-50 border-t border-slate-100 flex justify-between items-center">
                                                <span className={`text-[10px] font-black px-2 py-1 rounded-full uppercase ${p.status === 'Terbang' ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-200 text-slate-500'}`}>
                                                    {p.status}
                                                </span>
                                                {p.ownerId === user?.uid ? (
                                                    <button onClick={() => handleDeletePlane(p.id)} className="text-slate-300 hover:text-red-500 transition-colors"><Icon name="trash-2" size={18} /></button>
                                                ) : (
                                                    <button onClick={() => sendConnectionRequest(p)} className="bg-sky-600 hover:bg-sky-700 text-white text-[10px] font-black px-4 py-2 rounded-xl flex items-center gap-2 shadow-sm transition-all active:scale-95">
                                                        <Icon name="send" size={14} /> REQUEST
                                                    </button>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                    {fleet.length === 0 && <div className="col-span-full py-20 text-center text-slate-300 font-bold border-2 border-dashed rounded-3xl">Belum ada pesawat.</div>}
                                </div>
                            </div>
                        )}

                        {/* VIEW: INBOX */}
                        {activeTab === 'inbox' && (
                            <div className="max-w-2xl mx-auto space-y-6 animate-fade-up">
                                <div>
                                    <h2 className="text-2xl font-black text-slate-900">Kotak Masuk Request</h2>
                                    <p className="text-slate-500 text-sm">Kelola permintaan koneksi bandara untuk armada Anda.</p>
                                </div>
                                <div className="space-y-4">
                                    {incomingReqs.length === 0 ? (
                                        <div className="bg-white p-12 rounded-[2rem] border border-slate-200 text-center text-slate-400">Belum ada permintaan koneksi.</div>
                                    ) : (
                                        incomingReqs.map(req => (
                                            <div key={req.id} className="bg-white p-5 rounded-3xl border border-slate-200 shadow-sm flex items-center justify-between">
                                                <div className="flex items-center gap-4">
                                                    <div className="w-12 h-12 bg-sky-50 text-sky-600 rounded-2xl flex items-center justify-center font-black">{req.planeReg.charAt(0)}</div>
                                                    <div>
                                                        <p className="text-sm font-bold"><span className="text-sky-600">{req.requesterName}</span> ingin koneksi ke <span className="text-slate-900">{req.planeReg}</span></p>
                                                        <p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">{new Date(req.timestamp).toLocaleDateString()}</p>
                                                    </div>
                                                </div>
                                                <div className="flex gap-2">
                                                    <button onClick={() => handleUpdateStatus(req.id, 'accepted')} className="bg-emerald-500 text-white p-2.5 rounded-xl shadow-lg shadow-emerald-100 transition-transform active:scale-90"><Icon name="check" /></button>
                                                    <button onClick={() => handleUpdateStatus(req.id, 'declined')} className="bg-slate-100 text-slate-400 p-2.5 rounded-xl transition-transform active:scale-90"><Icon name="x" /></button>
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                                {requests.filter(r => r.ownerId === user?.uid && r.status === 'accepted').length > 0 && (
                                    <div className="pt-8">
                                        <h3 className="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">Kontrak Disetujui</h3>
                                        <div className="bg-white rounded-3xl border border-slate-100 overflow-hidden divide-y divide-slate-50">
                                            {requests.filter(r => r.ownerId === user?.uid && r.status === 'accepted').map(req => (
                                                <div key={req.id} className="p-4 flex justify-between items-center text-xs">
                                                    <span className="font-bold">{req.planeReg} â†” {req.requesterName}</span>
                                                    <span className="text-[9px] font-black px-2 py-0.5 bg-emerald-50 text-emerald-600 rounded-full">CONNECTED</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </main>

                    {/* MODAL: ADD PLANE */}
                    {isModalOpen && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
                            <form onSubmit={addPlane} className="bg-white rounded-[2.5rem] shadow-2xl w-full max-w-lg p-8 animate-fade-up">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="text-2xl font-black text-slate-900 tracking-tight">Daftarkan Pesawat</h3>
                                    <button type="button" onClick={() => setIsModalOpen(false)} className="text-slate-400 hover:text-slate-600">âœ•</button>
                                </div>
                                <div className="grid grid-cols-2 gap-4 mb-6">
                                    <InputGroup label="Registrasi" value={formData.reg} onChange={v => setFormData({...formData, reg: v})} placeholder="PK-GIA" />
                                    <InputGroup label="Tipe Pesawat" value={formData.type} onChange={v => setFormData({...formData, type: v})} placeholder="B77W / A333" />
                                    <div className="space-y-1">
                                        <label className="text-[10px] font-black text-slate-400 uppercase ml-1 tracking-widest">Pabrikan</label>
                                        <select className="w-full bg-slate-50 px-4 py-3 rounded-2xl font-bold text-sm outline-none" value={formData.manufacturer} onChange={e => setFormData({...formData, manufacturer: e.target.value})}>
                                            {['Boeing', 'Airbus', 'ATR', 'Embraer', 'Other'].map(m => <option key={m}>{m}</option>)}
                                        </select>
                                    </div>
                                    <div className="space-y-1">
                                        <label className="text-[10px] font-black text-slate-400 uppercase ml-1 tracking-widest">Kelas</label>
                                        <select className="w-full bg-slate-50 px-4 py-3 rounded-2xl font-bold text-sm outline-none" value={formData.cat} onChange={e => setFormData({...formData, cat: e.target.value})}>
                                            {['S', 'M', 'L', 'XL'].map(c => <option key={c} value={c}>{c} Class</option>)}
                                        </select>
                                    </div>
                                    <InputGroup label="Range (NM)" type="number" value={formData.range} onChange={v => setFormData({...formData, range: v})} />
                                    <InputGroup label="Pax Capacity" type="number" value={formData.seats} onChange={v => setFormData({...formData, seats: v})} />
                                </div>
                                <button type="submit" className="w-full bg-sky-600 hover:bg-sky-700 text-white py-4 rounded-2xl font-black shadow-lg shadow-sky-100 transition-all active:scale-[0.98]">SIMPAN KE CLOUD</button>
                            </form>
                        </div>
                    )}
                </div>
            );
        }

        const NavTab = ({ active, onClick, icon, label, badge = 0 }) => (
            <button onClick={onClick} className={`relative flex items-center gap-2 px-3 sm:px-4 py-2 rounded-xl font-bold text-sm transition-all ${active ? 'bg-sky-50 text-sky-600' : 'text-slate-400 hover:text-slate-600'}`}>
                <Icon name={icon} size={18} />
                <span className="hidden md:inline">{label}</span>
                {badge > 0 && <span className="absolute -top-1 -right-1 min-w-[18px] h-[18px] bg-red-500 text-white text-[10px] flex items-center justify-center rounded-full border-2 border-white font-black">{badge}</span>}
            </button>
        );

        const StatCard = ({ label, value, icon, color, bg }) => (
            <div className="bg-white p-5 rounded-3xl border border-slate-200 shadow-sm">
                <div className={`w-10 h-10 ${bg} ${color} rounded-xl flex items-center justify-center mb-4`}><Icon name={icon} size={20} /></div>
                <div className="text-2xl font-black text-slate-900">{value}</div>
                <div className="text-[10px] font-black text-slate-400 uppercase tracking-widest mt-1">{label}</div>
            </div>
        );

        const InputGroup = ({ label, value, onChange, placeholder, type = "text" }) => (
            <div className="space-y-1">
                <label className="text-[10px] font-black text-slate-400 uppercase ml-1 tracking-widest">{label}</label>
                <input required type={type} placeholder={placeholder} value={value} onChange={e => onChange(e.target.value)} className="w-full bg-slate-50 px-4 py-3 rounded-2xl font-bold text-sm outline-none focus:ring-2 focus:ring-sky-500 transition-all" />
            </div>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
</body>
</html>
